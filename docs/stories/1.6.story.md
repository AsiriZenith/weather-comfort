# Story 1.6: Authentication & Authorization - Auth0 Integration

## Status
Deferred

Note: Authentication backend implementation deferred until frontend dashboard is in place.

## Story
**As a** system administrator,  
**I want** to secure the Comfort Index dashboard with Auth0 authentication and authorization,  
**so that** only authenticated, whitelisted users can access the dashboard, and the system enforces multi-factor authentication for enhanced security.

## Acceptance Criteria
1. All API endpoints shall require authentication using Auth0 JWT Bearer tokens
2. Authentication shall be implemented using Auth0 with JWT token validation middleware
3. Multi-factor authentication (MFA) via email verification shall be enabled in Auth0
4. Public signups shall be disabled in Auth0 configuration
5. Only whitelisted users shall be allowed to log in
6. Controllers shall use authorization attributes to enforce authentication requirements
7. Unauthenticated requests shall return appropriate HTTP 401 Unauthorized responses

## Tasks / Subtasks
- [ ] Task 1: Install and configure Auth0 NuGet packages (AC: 2)
  - [ ] Install `Microsoft.AspNetCore.Authentication.JwtBearer` package
  - [ ] Install `Auth0.AspNetCore.Authentication` package (if using Auth0 SDK)
  - [ ] Add Auth0 configuration settings to appsettings.json (Domain, ClientId, ClientSecret, Audience)
  - [ ] Create configuration model/class for Auth0 settings
- [ ] Task 2: Configure Auth0 authentication in Program.cs (AC: 2, 3, 4, 5)
  - [ ] Add JWT Bearer authentication scheme to services
  - [ ] Configure Auth0 JWT token validation (Authority, Audience, TokenValidationParameters)
  - [ ] Set up authentication middleware in request pipeline (UseAuthentication before UseAuthorization)
  - [ ] Configure Auth0 settings to disable public signups
  - [ ] Configure Auth0 settings to enable MFA via email verification
  - [ ] Configure Auth0 user whitelist/allowlist mechanism
- [ ] Task 3: Apply authorization to existing controllers (AC: 1, 6, 7)
  - [ ] Add `[Authorize]` attribute to WeatherController (if exists) or create it
  - [ ] Add `[Authorize]` attribute to CacheDebugController
  - [ ] Ensure all API endpoints require authentication by default
  - [ ] Test that unauthenticated requests return 401 Unauthorized
- [ ] Task 4: Create Auth0 configuration infrastructure (AC: 2)
  - [ ] Create Auth0 configuration class in Config/ or Infrastructure/ folder
  - [ ] Load Auth0 settings from configuration (appsettings.json)
  - [ ] Validate required Auth0 configuration values at startup
  - [ ] Add appropriate error handling for missing/invalid Auth0 configuration
- [ ] Task 5: Configure Auth0 tenant settings (AC: 3, 4, 5)
  - [ ] Document Auth0 tenant configuration requirements
  - [ ] Configure MFA via email verification in Auth0 dashboard
  - [ ] Disable public signups in Auth0 dashboard
  - [ ] Set up user whitelist/allowlist in Auth0 (via Rules, Actions, or custom database)
  - [ ] Document Auth0 tenant setup steps for deployment
- [ ] Task 6: Unit testing (AC: 1, 6, 7)
  - [ ] Create unit tests for authentication middleware configuration
  - [ ] Test that controllers with [Authorize] reject unauthenticated requests
  - [ ] Test that valid JWT tokens are accepted
  - [ ] Test that invalid/expired JWT tokens are rejected
  - [ ] Mock Auth0 token validation for isolated unit testing
  - [ ] Test authorization attribute application on controllers
  - [ ] Test 401 Unauthorized response for unauthenticated requests

## Dev Notes

### Previous Story Insights
**From Story 1.5:**
- `CacheDebugController` exists at `weather-comfort.Server/Controllers/CacheDebugController.cs`
- `Program.cs` currently has `app.UseAuthorization()` but no authentication middleware configured
- IMemoryCache is registered and available for dependency injection
- Services are registered as Scoped (WeatherService, ComfortIndexService, RankingService)

**From Story 1.4:**
- `RankingService` is available and provides ranking functionality
- Service works with `ComfortIndexDto` data from `ComfortIndexService`

**From Story 1.3:**
- `ComfortIndexService` is available and provides `CalculateComfortIndex()` and `CalculateComfortIndexForAll()` methods
- Service returns `ComfortIndexDto` with properties: `Score` (double), `CityId` (int), `CityName` (string)

**From Story 1.2:**
- `WeatherService` provides `GetWeatherForAllCitiesAsync()` and `GetWeatherForCityAsync()` methods
- `OpenWeatherClient` in Infrastructure/ folder handles HTTP calls to OpenWeatherMap API

### Data Models
**Auth0 Configuration (New)** [Source: architecture/3-backend-architecture.md#3.4, prd/4-functional-requirements.md#4.6]
- Location: `weather-comfort.Server/Config/Auth0Settings.cs` or `weather-comfort.Server/Infrastructure/Auth0Config.cs`
- Properties: `Domain` (string), `ClientId` (string), `ClientSecret` (string), `Audience` (string)
- Configuration loaded from appsettings.json
- Used for JWT token validation and Auth0 integration

### API Specifications
**Authentication Requirements** [Source: architecture/3-backend-architecture.md#3.7, prd/4-functional-requirements.md#4.6]
- All API endpoints require authentication using Auth0 JWT Bearer tokens
- JWT tokens are validated using Auth0's public key infrastructure
- Unauthenticated requests return HTTP 401 Unauthorized
- Authorization enforced using `[Authorize]` attributes on controllers

**Auth0 Configuration** [Source: architecture/3-backend-architecture.md#3.7, prd/4-functional-requirements.md#4.6]
- JWT Bearer authentication scheme
- Token validation middleware validates tokens against Auth0
- MFA enabled via Auth0 email verification (configured in Auth0 dashboard)
- Public signups disabled (configured in Auth0 dashboard)
- Whitelisted users only (configured in Auth0 via Rules, Actions, or custom database)

### Component Specifications
N/A - This is a backend-only story with no frontend components. Frontend authentication integration will be handled in a future story.

### File Locations
**Backend Structure** [Source: architecture/3-backend-architecture.md#3.1, #3.4, #3.7]
- `weather-comfort.Server/Config/Auth0Settings.cs` or `weather-comfort.Server/Infrastructure/Auth0Config.cs` - Auth0 configuration class
- `weather-comfort.Server/Program.cs` - Auth0 authentication middleware configuration
- `weather-comfort.Server/Controllers/*.cs` - Controllers requiring `[Authorize]` attributes
- `weather-comfort.Server/appsettings.json` - Auth0 configuration settings (Domain, ClientId, ClientSecret, Audience)

**Project Structure** [Source: architecture/3-backend-architecture.md#3.1]
- Config/ or Infrastructure/ - Contains Auth0 configuration class
- Controllers/ - Controllers with `[Authorize]` attributes applied
- Program.cs - Authentication and authorization middleware configuration

### Testing Requirements
**Testing Strategy** [Source: architecture/3-backend-architecture.md]
- Unit tests should be created for authentication configuration
- Test file location: `weather-comfort.Server.Tests/` following existing test structure
- Test scenarios:
  1. Authentication middleware configuration - JWT Bearer scheme properly configured
  2. Controller authorization - Controllers with [Authorize] reject unauthenticated requests
  3. Valid JWT token acceptance - Valid tokens from Auth0 are accepted
  4. Invalid JWT token rejection - Invalid/expired tokens are rejected with 401
  5. Configuration validation - Missing/invalid Auth0 configuration is detected at startup
  6. Authorization attribute application - All required controllers have [Authorize] attributes
  7. HTTP 401 response - Unauthenticated requests return proper 401 Unauthorized response

**Testing Standards**
- Use mocking framework (Moq) for Auth0 token validation
- Mock JWT tokens for testing authentication scenarios
- Follow ASP.NET Core testing best practices
- Test both success and failure scenarios
- Test authentication middleware pipeline order (UseAuthentication before UseAuthorization)
- Follow existing test patterns from WeatherServiceTests and CacheDebugControllerTests

### Technical Constraints
**Backend Framework** [Source: architecture/1-architecture-overview.md, architecture/3-backend-architecture.md#3.1]
- ASP.NET Core Web API
- Use dependency injection for service registration
- Follow pragmatic layered architecture (not full Clean Architecture)
- Business logic in Services layer, not Controllers
- Authentication logic in middleware, not controllers [Source: architecture/3-backend-architecture.md#3.7]

**Authentication Strategy** [Source: architecture/3-backend-architecture.md#3.7, prd/4-functional-requirements.md#4.6]
- JWT Bearer authentication using Auth0
- Token validation middleware validates tokens against Auth0's public key infrastructure
- All API endpoints require authentication [Source: architecture/3-backend-architecture.md#3.7]
- MFA enabled via Auth0 email verification [Source: prd/4-functional-requirements.md#4.6]
- Public signups disabled [Source: prd/4-functional-requirements.md#4.6]
- Whitelisted users only [Source: prd/4-functional-requirements.md#4.6]
- No authentication logic exists in controllers beyond authorization attributes [Source: architecture/3-backend-architecture.md#3.7]

**Service Registration** [Source: architecture/3-backend-architecture.md#3.3]
- Services contain core business logic
- Register in Program.cs using standard ASP.NET Core DI patterns
- Authentication middleware registered in Program.cs request pipeline
- UseAuthentication() must be called before UseAuthorization() in middleware pipeline

**Error Handling** [Source: prd/4-functional-requirements.md#4.6]
- Unauthenticated requests must return HTTP 401 Unauthorized
- Invalid/expired tokens must be rejected with appropriate error responses
- Missing Auth0 configuration should be detected at startup with clear error messages
- Authentication failures should be logged appropriately using ILogger

### Project Structure Notes
- Architecture follows pragmatic layered approach [Source: architecture/7-design-decisions-trade-offs.md]
- No heavy architectural patterns required
- Focus on clear separation of concerns and testability
- Auth0 configuration belongs in Infrastructure/ or Config/ folder [Source: architecture/3-backend-architecture.md#3.4]
- Authentication middleware configured in Program.cs, not in controllers [Source: architecture/3-backend-architecture.md#3.7]

**Note on Auth0 Configuration**: 
- Auth0 tenant settings (MFA, public signups, whitelist) are configured in the Auth0 dashboard, not in code
- The backend code validates JWT tokens issued by Auth0
- User whitelisting can be implemented via:
  1. Auth0 Rules (JavaScript rules that check user metadata)
  2. Auth0 Actions (newer, more flexible approach)
  3. Custom database connection with user allowlist
- The specific whitelist implementation approach should be documented but is primarily an Auth0 dashboard configuration

**Note on Middleware Order**: 
- In ASP.NET Core, `UseAuthentication()` must be called before `UseAuthorization()` in the request pipeline
- Current Program.cs has `app.UseAuthorization()` but no `app.UseAuthentication()` - this needs to be added

**Note on Controller Authorization**:
- Controllers should use `[Authorize]` attribute at the class level to require authentication for all endpoints
- Individual endpoints can override with `[AllowAnonymous]` if needed (though not required for this story)
- CacheDebugController and any WeatherController should have `[Authorize]` applied

## Testing

### Testing Standards from Architecture
- Test file location: Follow ASP.NET Core test project conventions (`weather-comfort.Server.Tests/`)
- Test standards: Unit tests for authentication configuration and controller authorization
- Testing frameworks: Use standard .NET testing frameworks (xUnit, NUnit, or MSTest) - follow existing test project structure
- Specific testing requirements for this story:
  - Test authentication middleware configuration
  - Test controller authorization enforcement
  - Test JWT token validation (valid and invalid tokens)
  - Test HTTP 401 responses for unauthenticated requests
  - Mock Auth0 token validation for isolated unit testing
  - Test configuration validation at startup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-28 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results

_To be populated by QA Agent_

